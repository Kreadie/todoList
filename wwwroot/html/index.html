<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task list</title>
</head>
<body>
    <div>
        <form id="task-form">
            <p>Title <input id="task-title" name="title"></p>
	    <p>Date <input type="date" id="task-date" name="date"></p>
            <button onclick="taskAdd(event)" id="task-submit" type="submit">Add</button>
        </form>
    </div>
    <h1>Tasks: </h1>
    <div id="task-container"></div>
<script>
    
    async function loadTasks() {
	const response = await fetch("/task-load", {
	    method: "GET",
	    headers: {"Accept": "application/json"}
	});

	if(response.ok) {
	    const tasks = await response.json();
	    createTaskElements(tasks);
	}
        }

    function createTaskElements(tasks) {
            const container = document.getElementById("task-container");
	    const table = document.createElement("table");

	    container.insertAdjacentElement("beforeend", table);
	const dateHtml = `<tr>
	    <th scope="col"> Status </th>
	    <th scope="col"> Title </th>
	    <th scope="col"> Date </th>
	    </tr>`;

	    const today = new Date();
            for(let t of tasks) {
	        let d = Date.parse(t.date);
	        d = new Date(d);
		let properMonth = d.getMonth() + 1;

		const tableRow = document.createElement("tr");
		const tCheck = document.createElement("input");
		tCheck.setAttribute("type", "checkbox");
		tCheck.addEventListener("change", function() {
	    	if(this.checked)
		    completeTask(t.id);
		});

		const tTitle = document.createElement("td");
		tTitle.innerHTML = t.title;
		const tDate = document.createElement("td");
		tDate.innerHTML = d.getDate() + "." + properMonth + "." + d.getFullYear();

		tableRow.insertAdjacentElement("beforeend", tCheck);
		tableRow.insertAdjacentElement("beforeend", tTitle);
		tableRow.insertAdjacentElement("beforeend", tDate);
		if(d.getTime() < today)
		tDate.style.color = "red";

		table.insertAdjacentElement("afterbegin", tableRow);
            }
	    table.insertAdjacentHTML("afterbegin", dateHtml);
        }
    function test(t) {
	if(this.checked)
	    completeTask(t.id);
    }


    async function completeTask(id) {
	const response = await fetch(`/task-delete/${id}`, {
	    method: "DELETE",
	    headers: {"Content-Type" : "application/json"},
	    body: JSON.stringify({id})
    });
	if(response.ok) {
	    alert("Task completed!");
	    window.location.reload();
	}
    }
        async function taskAdd(event){
            event.preventDefault();

            const title = document.getElementById("task-title").value;
	    const date = document.getElementById("task-date").value;
            if(title == "") {
                alert("Add task title");
                return;
            }
	    if(date == "") {
		alert("Add task finishing date");
		return;
	    }

            const response = await fetch("/task-add", {
                method: "POST",
                headers: {"Content-Type" : "application/json"},
                body: JSON.stringify({title : title, date : date})
            });
            if(response.ok) {
		document.getElementById("task-title").value = "";
		document.getElementById("task-date").value = Date();
                window.location.reload();
            }
        }
        loadTasks();
    </script>
</body>
</html>
